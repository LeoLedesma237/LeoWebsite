---
title: "Adding Demographic Information"
output: html_document
---

### Universal block code settings

```{r universal block code setting}
knitr::opts_chunk$set(echo = TRUE)
knitr::opts_chunk$set(message = FALSE)
knitr::opts_chunk$set(comment = NULL)
```

### Load in the data manipulation packages first

```{r load in packages, message= FALSE, warning = FALSE}
# Load in the proper packages
library(tidyverse)
library(readr)
library(readxl)
```

### Last day this code was ran

```{r last day the code was ran}

paste("This code was last ran on:", Sys.Date())

```

### Load in the data

We will be loading demographic information for the ONR study and then merging it with our GnG and Nback CSVs. Demographic information is saved in a screener that is used to assess whether participants are eligible to participate in the study. Unfortunately this screener does not contain ID numbers for the participants. However, we can get around this by merging it with the SharePoint ID's since they contain matching email addressed- this is what we will be doing below.

Message: Had to drop ID's 14 and 90 because their inclusion led to weird merger between the two datasets below. Might be from having multiple screening emails. 

```{r load in demographic information, warning = FALSE}
# Set working directory
setwd("C:/Users/lledesma.TIMES/Documents/ONR/Demographics")

# Load in the following data
PilotIDs <- read.csv("PilotIDs.csv")
Screener.Ano <- read.csv("Anonymous.Screener.csv")
Screener.SONA <- read.csv("SONA.Screener.csv")
Screener.ROTC <- read.csv("ROTC.Screener.csv")

# Check the dimensions of the screeners
dim(Screener.Ano)
dim(Screener.SONA)
dim(Screener.ROTC)

# Remove the first two rows of the Screeners (They are meaningless)
Screener.Ano <- Screener.Ano[3:nrow(Screener.Ano),]
Screener.SONA <- Screener.SONA[3:nrow(Screener.SONA),]
Screener.ROTC <- Screener.ROTC[3:nrow(Screener.ROTC),]


# Select the variables of interest from the screeners
Screener.Ano <- Screener.Ano %>%
  select(email = Q94,
         race = RE1,
         ethnicity = RE2,
         Sex,
         Age = AgeYears) %>%
  data.frame() %>%
  unique()

Screener.SONA <- Screener.SONA %>%
  select(email = Q94,
         race = RE1,
         ethnicity = RE2,
         Sex,
         Age = AgeYears) %>%
  data.frame() %>%
  unique()

Screener.ROTC <- Screener.ROTC %>%
  select(email = RecipientEmail,
         race = RE1,
         ethnicity = RE2,
         Sex,
         Age = AgeYears) %>%
  data.frame() %>%
  unique()
  

# Bind all of the Screeners into one dataset
Screener <- Screener.Ano %>%
  rbind(Screener.SONA) %>%
  rbind(Screener.ROTC)


# Select the variables of interest for PilotIDs
PilotIDs <- PilotIDs %>%
  select(email = Email,
         ID = ParticipantID) %>%
  data.frame()

# Drop ID's 90 and 14 because they come out weird in the dataset
PilotIDs <- PilotIDs %>%
  filter(!(ID %in% c("14","90")))


# Merge these two datasets to obtain the demographics for each ID
demographics <- Screener %>%
  merge(PilotIDs, by = "email")

# Drop the row if the ID column contains an NA
demographics <- demographics %>%
  drop_na(ID)

# Some extra data cleaning
demographics <- demographics %>%
  select(ID, everything()) %>%
  arrange(ID)

```


### Adding demographics manually

Unfortunately for some reason, Age and Sex was unable to be recovered from some ID's with the code from above- thus these have been added manually in a separate excel sheet. If this excel sheet does not contain that information then that means it was not recorded during our Day 2 and to the best of my knowledge unattainable unless the participant is contacted for it. No information on race or ethnicity could be recovered regardless.

```{r manual demographics, warning= FALSE}
# Set working directory
setwd("~/ONR/Demographics")

# Load in the manual demographic sheet
manual.demographics <- read_excel("demographics.manual.xlsx")

# no demographic information avaiable
paste("Warning, no demographic information could be found for the following ID:", manual.demographics$ID[is.na(manual.demographics$Age)],sep=" ")

# Add manual demographics to the rest of our demographics dataset
manual.demographics$email <- NA
manual.demographics$race <- NA
manual.demographics$ethnicity <- NA

manual.demographics <- manual.demographics %>% select(ID, email, race, ethnicity, Sex, Age)

demographics <- demographics %>%
  rbind(manual.demographics)
```
### Current demographic information numbers

```{r count demographic info numbers}
paste("We have demographic information for:", length(unique(demographics$ID)),"participants out of", length(unique(PilotIDs$ID)), sep=" ")

```

### Save demographic information

```{r save demographic information, warning = FALSE}
# Set save working directory
setwd("C:/Users/lledesma.TIMES/Documents/ONR/Demographics")

# Save the data as a CSV
write.csv(x = demographics, file = "complete.demographics.csv")

```
